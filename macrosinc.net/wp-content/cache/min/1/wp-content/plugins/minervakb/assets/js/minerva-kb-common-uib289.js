(function($){'use strict';var GLOBAL_DATA=window.MinervaKB||{};var settings=GLOBAL_DATA.settings||{};if(!Array.prototype.includes){Object.defineProperty(Array.prototype,'includes',{value:function(searchElement,fromIndex){if(this==null){throw new TypeError('"this" is null or not defined')}
var o=Object(this);var len=o.length>>>0;if(len===0){return!1}
var n=fromIndex|0;var k=Math.max(n>=0?n:len-Math.abs(n),0);function sameValueZero(x,y){return x===y||(typeof x==='number'&&typeof y==='number'&&isNaN(x)&&isNaN(y))}
while(k<len){if(sameValueZero(o[k],searchElement)){return!0}
k++}
return!1}})}
function makeArray(thing){if(!thing){return[]}
return[].slice.apply(thing)}
function getElementIndex(node){var index=0;while((node=node.previousElementSibling)){index++}
return index}
function humanFileSize(bytes,si){var thresh=si?1000:1024;if(Math.abs(bytes)<thresh){return bytes+'B'}
var units=si?['kB','MB','GB','TB','PB','EB','ZB','YB']:['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];var u=-1;do{bytes/=thresh;++u}while(Math.abs(bytes)>=thresh&&u<units.length-1);return bytes.toFixed(1)+''+units[u]}
function setupQuillEditor(options){var $form=options.$form;var isStandaloneUploadButton=settings.tickets_create_use_standalone_upload_button;var toolbarOptions=options.toolbarOptions||[[{'header':[1,2,3,4,5,6,!1]}],['bold','italic','underline','strike'],[{'list':'ordered'},{'list':'bullet'}],['link'],['blockquote','code-block'],['clean']];if(options.fileUpload&&!isStandaloneUploadButton){toolbarOptions.push(['upload'])}
var quillEditor=new Quill(options.editorSelector,{modules:{toolbar:toolbarOptions,history:{delay:2000,maxStack:500,userOnly:!0}},placeholder:options.placeholder||'Write your message here...',theme:options.theme||'snow'});quillEditor.clipboard.addMatcher(Node.ELEMENT_NODE,function(node,delta){var ops=[];delta.ops.forEach(function(op){var urlRegex=/https?:\/\/[^\s]+/g;if(op.insert&&typeof op.insert==='string'){if(op.attributes&&op.attributes.link){ops.push({insert:op.insert.trim(),attributes:{link:op.attributes.link}})}else{ops.push({insert:op.insert})}}});delta.ops=ops;return delta});if(!options.fileUpload){return quillEditor}
var isAttachmentsOpen=!1;var uploadButton=isStandaloneUploadButton?$form.find('.js-mkb-ticket-attach-files')[0]:$form.find('.ql-upload')[0];var $attachmentsSection=$form.find('.js-mkb-editor-attachments-section');uploadButton.addEventListener('click',function(e){e.preventDefault();if(!isStandaloneUploadButton){uploadButton.classList.toggle('state--on')}
$attachmentsSection[isAttachmentsOpen?'slideUp':'slideDown'](250);isAttachmentsOpen=!isAttachmentsOpen});setupFileUpload({$dropArea:$form.find('.js-mkb-editor-attachments-drop-area'),$form:$form});return quillEditor}
function setupFileUpload(options){var $dropArea=options.$dropArea;var $form=options.$form;if(!$dropArea||!$dropArea.length||!$form||!$form.length){console.log('Could not initialize file uploader');return}
var dropArea=$dropArea.get(0);var $preview=$dropArea.find('.js-mkb-file-upload-preview');var $clearFiles=$dropArea.find('.js-mkb-file-upload-clear');var $uploadBtn=$dropArea.find(".js-mkb-file-upload-store");var $fileStore=$uploadBtn;var $dropErrors=$dropArea.find('.js-mkb-file-upload-drop-errors');var allowedTypes=$fileStore.attr('accept')||'';var maxFiles=$fileStore.data('maxFiles');var maxFileSizeInMb=$fileStore.data('maxFileSize');$form.attr('enctype','multipart/form-data');allowedTypes=allowedTypes.split(',').map(function(type){return type.trim().replace('.','')});['dragenter','dragover','dragleave','drop'].forEach(function(eventName){document.body.addEventListener(eventName,function preventDefaults(e){e.preventDefault();e.stopPropagation()},!1)});['dragenter','dragover'].forEach(function(eventName){dropArea.addEventListener(eventName,function highlight(){$dropArea.addClass('mkb-drop-highlight')},!1)});['dragleave','drop'].forEach(function(eventName){dropArea.addEventListener(eventName,function unhighlight(){$dropArea.removeClass('mkb-drop-highlight')},!1)});dropArea.addEventListener('drop',function(e){handleAddedFiles(e.dataTransfer.files,!0)},!1);$uploadBtn.get(0).addEventListener('change',function(){handleAddedFiles(this.files)},!1);function createDataTransferObject(){return new ClipboardEvent('').clipboardData||new DataTransfer()}
var hasNotAllowedFilesError=!1;var hasTooLargeFilesError=!1;var hasTooManyFiles=!1;var fileAlreadyAddedError=!1;function handleAddedFiles(addedFiles,isDragAndDrop){isDragAndDrop=isDragAndDrop||!1;var oldFilesArr=isDragAndDrop?makeArray($fileStore.prop('files')):[];var newFilesArray=makeArray(addedFiles);var oldFileNames=oldFilesArr.map(function(item){return item.name});hasNotAllowedFilesError=!1;hasTooLargeFilesError=!1;hasTooManyFiles=!1;fileAlreadyAddedError=!1;if(oldFilesArr.length>=maxFiles){hasTooManyFiles=!0;handleAddFileErrors();return}
console.log('adding files',newFilesArray);newFilesArray=newFilesArray.filter(function(item){var extension=item.name.split('.').pop().toLowerCase();var isAllowed=allowedTypes.includes(extension);var isValidSize=item.size/(1024*1024)<=maxFileSizeInMb;var isAlreadyAdded=oldFileNames.includes(item.name);if(!isAllowed){hasNotAllowedFilesError=!0}
if(!isValidSize){hasTooLargeFilesError=!0}
if(isAlreadyAdded){fileAlreadyAddedError=!0}
return isAllowed&&isValidSize&&!isAlreadyAdded});var allFilesArr=oldFilesArr.concat(newFilesArray);if(allFilesArr.length>maxFiles){hasTooManyFiles=!0;allFilesArr=allFilesArr.slice(0,maxFiles)}
var allFiles=createDataTransferObject();allFilesArr.forEach(function(file){allFiles.items.add(file)});if(allFiles.files.length){$fileStore.prop('files',allFiles.files)}else{clearFiles()}
handleAddFileErrors();updatePreview(allFiles.files);console.log('[DEBUG]: Files in storage',$fileStore.prop('files'))}
function handleAddFileErrors(){clearErrors();var addFileErrors=[];if(hasNotAllowedFilesError){addFileErrors.push('Some of the added files are not allowed')}
if(hasTooLargeFilesError){addFileErrors.push('Some of the added files are too large')}
if(hasTooManyFiles){addFileErrors.push('Maximum file limit is reached, some files were not added')}
if(fileAlreadyAddedError){addFileErrors.push('Some of the files are already added')}
if(addFileErrors.length){$dropErrors.html(addFileErrors.reduce(function(html,error){return html+'<div>'+error+'</div>'},''))}}
function clearErrors(){$dropErrors.html('')}
function updatePreview(files){$preview.html('');files=makeArray(files);files.forEach(function addFilePreview(file){var isImage=/^image\//.test(file.type);var $item=$('<div class="js-mkb-attachment-upload-preview-item mkb-attachment-upload-preview-item">'+'<a href="#" class="js-mkb-attachment-preview-remove mkb-attachment-preview-remove fa fa-times-circle"></a>'+'</div>');if(isImage){var reader=new FileReader();reader.readAsDataURL(file);reader.onloadend=function(){var img=document.createElement('img');img.src=reader.result;$item.append(img)};$item.addClass('type--image')}else{$item.append('<span>'+file.name+' ('+humanFileSize(file.size,!0)+')'+'</span>');$item.addClass('type--file')}
$preview.append($item)})}
$preview.on('click','.js-mkb-attachment-preview-remove',function(e){e.preventDefault();var indexToRemove=getElementIndex(e.currentTarget.parentNode);var currentFilesArray=makeArray($fileStore.prop('files'));var updatedFiles=createDataTransferObject();currentFilesArray.filter(function(file,index){return index!==indexToRemove}).forEach(function(file,index){updatedFiles.items.add(file)});if(updatedFiles.files.length){$fileStore.prop('files',updatedFiles.files);updatePreview(updatedFiles.files);console.log('[DEBUG]: Files in storage',$fileStore.prop('files'))}else{clearFiles()}
clearErrors()});function clearFiles(){$fileStore.val(null);updatePreview([]);console.log('[DEBUG]: Files in storage',$fileStore.prop('files'))}
$clearFiles.on('click',function(e){e.preventDefault();e.stopImmediatePropagation();clearFiles();clearErrors()})}
function Form(el,options){options=options||{};this._isLoading=!1;this.options=options;this.controls={};this.quillEditors=this.options.quillEditors||[];this.el=el;this.$el=$(el);this.$messagesEl=this.$el.find('.js-mkb-form-messages');this.$submit=this.$el.find('.js-mkb-form-submit');this.submitLabel=this.$submit.val();this.submitLoadingLabel=this.$submit.data('progress-label');this.findControls()}
Form.prototype.findControls=function(){var $controls=this.$el.find('input:not(.js-mkb-form-submit), select, textarea');this.controls=makeArray($controls).map(function(el){return{id:el.getAttribute('name'),el:el,$el:$(el)}})};Form.prototype.isLoading=function(){return this._isLoading};Form.prototype.startLoading=function(){this._isLoading=!0;this.disableControls();this.disableControl(this.$submit);this.$submit.val(this.submitLoadingLabel);this.$el.addClass('state--loading');this.$el.append('<div class="js-mkb-form-overlay mkb-form-overlay"></div>')};Form.prototype.endLoading=function(){this._isLoading=!1;this.enableControls();this.enableControl(this.$submit);this.$submit.val(this.submitLabel);this.$el.find('.js-mkb-form-overlay').remove();this.$el.removeClass('state--loading')};Form.prototype.disableControls=function(){this.controls.forEach(function(control){this.disableControl(control.$el)}.bind(this));this.quillEditors.forEach(function(quillEditor){quillEditor.enable(!1)})};Form.prototype.lock=function(){this._isLoading=!0;this.disableControls();this.disableControl(this.$submit)};Form.prototype.enableControls=function(){this.controls.forEach(function(control){this.enableControl(control.$el)}.bind(this));this.quillEditors.forEach(function(quillEditor){quillEditor.enable(!0)})};Form.prototype.disableControl=function($control){$control.attr('disabled','disabled')};Form.prototype.enableControl=function($control){$control.attr('disabled',!1)};Form.prototype.showMessages=function(messages,messagesType){messagesType=messagesType||'error';this.clearMessages();this.$messagesEl.addClass('mkb-form-messages--'+messagesType).html(messages);$([document.documentElement,document.body]).animate({scrollTop:this.$messagesEl.offset().top-parseInt(settings.global_scroll_offset.size,10)},100)};Form.prototype.clearMessages=function(){this.$messagesEl.removeClass('mkb-form-messages--error mkb-form-messages--success').html('')};Form.prototype.serialize=function(){return $(this.el).serializeArray().reduce(function(store,kv){store[kv.name]=kv.value;return store},{})};window.MinervaCommonUI={Form:Form,setupQuillEditor:setupQuillEditor,setupFileUpload:setupFileUpload}})(window.jQuery)